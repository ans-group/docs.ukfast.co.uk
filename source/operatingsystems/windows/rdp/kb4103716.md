# KB4103716 - An authentication error has occurred - CredSSP Updates

On May 8th 2018 Microsoft released an update to the the Remote Desktop service that patches vulnerabilities in CredSSP, an authentication mechanism used by the service.

The patch specifically addresses [CVE-2018-0886](https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2018-0886) and full details are available on support.microsoft.com - [CredSSP updates for CVE-2018-0886](https://support.microsoft.com/en-us/help/4093492/credssp-updates-for-cve-2018-0886-march-13-2018). 

Following this update, some clients may find they are unable to access their servers with us and receive the following error message when attempting to connect via Remote Desktop:

```
An authentication error has occurred.

The function requested is not supported.

Remote computer: <hostname>

This could be due to CredSSP encryption oracle remediation.

For more information, see https://go.microsoft.com/fwlink/?linkid=866660
```

Additionally, an event with Event ID 6041 will be logged in the client's System Log with the following message text:

```
A CredSSP authentication to <hostname> failed to negotiate a common protocol version. The remote host offered version <Protocol Version> which is not permitted by Encryption Oracle Remediation.
```

## Further Details

In almost all cases, this error will occur because the above update has been applied on your client computer but *not* the server you are attempting to connect to.

A new Group Policy is introduced by this update on Windows Desktops entitled `Encryption Oracle Remediation`.

This policy has a number of possible 'Protection Levels', `Vulnerable`, `Mitigated` or `Force Updated Clients`. Prior to May 8th the default when this policy was unconfigured was `Vulnerable` but this has now been switched to `Mitigated` which will prevent connectivity to unpatched Windows servers. Enabling this and setting the 'Protection Level' to either `Mitigated` or `Force Updated Clients` will also prevent connectivity.

The same policy is present on patched Windows servers and connections from *unpatched* clients will also be prevented if the server's 'Protection Level' is set to `Force updated clients`. In this instance, the following error will be presented on the client computer:

```
An authentication error has occurred.

The token supplied to the function is invalid
```

## Resolution
Ideally, the inaccessible server should have the latest updates installed and a reboot performed so that CredSSP is patched against the vulnerability and updated clients are able to connect.

If an interim workaround is required, the `Encryption Oracle Remediation` policy on the client computer should be 'Enabled' and the 'Protection Level' set to `Vulnerable` but, as the label suggests, this will leave you at risk of compromise from the man-in-the-middle attack detailed in the CVE-2018-0886. Please note, changes to this policy will not take effect until after a reboot.

This policy can be accessed via the `Edit Group Policy` Windows Start Menu item or by pressing `Win + R` and typing `gpedit.msc` > OK and then navigating through the tree on the left-hand-side to:

```
Computer Configuration -> Administrative Templates -> System -> Credentials Delegation > Encryption Oracle Remediation
```
Enable the policy, set the `Protection Level` to `Vulnerable` and click OK:

![Encryption Oracle Remediation Policy](files/kb4103716/enable_vuln_protection_level.PNG)


```eval_rst
.. meta::
    :title: KB4103716 - An authentication error has occurred - CredSSP Updates | UKFast Documentation
    :description: Guidance on necessary configuration following Microsoft updates to CredSSP
    :keywords: microsoft, windows, credssp, rdp, authentication, CVE-2018-0886
```
